<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Climático - EL TEMPLO DE LA MODA SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    // Paleta Sobria: Grises, Blanco y Azul Oscuro
                    colors: {
                        'primary-blue': '#1e3a8a', // Azul Oscuro (Blue 800)
                        'secondary-gray': '#f9fafb', // Gris Muy Claro (Gray 50)
                        'border-gray': '#e5e7eb', // Gris Claro para Bordes (Gray 200)
                        'accent-red': '#b91c1c', // Rojo Oscuro (Red 700)
                        'highlight-green': '#047857', // Verde Oscuro (Emerald 700)
                        'text-primary': '#111827', // Casi Negro (Gray 900)
                        'text-secondary': '#6b7280', // Gris Medio (Gray 500)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Estilo para el contenedor principal para centrar mejor en desktop */
        .container-wrapper {
            max-width: 1200px;
        }
        /* Estilo para la barra lateral fija en pantallas grandes */
        @media (min-width: 1024px) {
            .sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                height: 100vh;
                overflow-y: auto;
            }
        }
        /* Estilo para las pestañas */
        .tab-button {
            border-bottom-width: 2px;
            transition: all 0.15s;
        }
        .tab-button.active {
            border-color: #1e3a8a; /* primary-blue */
            color: #1e3a8a; /* primary-blue */
            font-weight: 600;
        }
        .tab-button:not(.active) {
            border-color: transparent;
            color: #6b7280; /* text-secondary */
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <header class="bg-white shadow-sm border-b border-border-gray sticky top-0 z-10">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
                <h1 class="text-xl font-bold tracking-tight text-primary-blue flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 mr-2 text-accent-red">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15a4.5 4.5 0 0 0 4.5 4.5h10.5a4.5 4.5 0 0 0 4.5-4.5M2.25 15h19.5" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18ZM9.75 8.25V4.5M14.25 8.25V4.5" />
                    </svg>
                    Análisis Climático - EL TEMPLO DE LA MODA SAS
                </h1>
            </div>
        </header>

        <div class="mx-auto container-wrapper px-4 py-8 sm:px-6 lg:px-8">
            <!-- PESTAÑAS DE NAVEGACIÓN -->
            <div class="mb-6 border-b border-border-gray">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <a href="{{ url_for('historial_detallado') }}"
                       class="tab-button {% if seccion_activa == 'historial' %}active{% endif %} whitespace-nowrap py-3 px-1 text-sm">
                        Historial Detallado
                    </a>
                    <a href="{{ url_for('ranking_anual') }}"
                       class="tab-button {% if seccion_activa == 'ranking' %}active{% endif %} whitespace-nowrap py-3 px-1 text-sm">
                        Ranking Anual de Tiendas
                    </a>
                </nav>
            </div>

            {% if seccion_activa == 'historial' %}
                <!-- SECCIÓN: HISTORIAL DETALLADO -->
                <div class="bg-white shadow-lg rounded-xl p-6 mb-8">
                    <h2 class="text-2xl font-semibold text-primary-blue mb-4">Consulta de Historial Climático</h2>
                    <form method="POST" action="{{ url_for('historial_detallado') }}" class="space-y-4">
                        <!-- FILTRO DE TIENDA Y AÑO -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4">
                            <div>
                                <label for="tienda" class="block text-sm font-medium text-text-primary mb-1">Seleccionar Tienda</label>
                                <select id="tienda" name="tienda" required
                                        class="mt-1 block w-full rounded-lg border border-border-gray bg-secondary-gray p-2.5 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                                    <option value="" disabled selected>--- Seleccione una Tienda ---</option>
                                    {% for tipo, nombres in tiendas_agrupadas.items() %}
                                        <optgroup label="{{ tipo }}">
                                            {% for nombre in nombres %}
                                                <option value="{{ nombre }}" {% if tienda_seleccionada == nombre %}selected{% endif %}>{{ nombre }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="año_filtro" class="block text-sm font-medium text-text-primary mb-1">Año de Consulta (2015 - {{ año_actual }})</label>
                                <input type="number" id="año_filtro" name="año_filtro" min="2015" max="{{ año_actual }}" value="{{ filtros_aplicados.año_filtro if filtros_aplicados.año_filtro else año_actual }}" required
                                       class="mt-1 block w-full rounded-lg border border-border-gray bg-secondary-gray p-2.5 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                            </div>
                        </div>

                        <!-- FILTROS ADICIONALES -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 pt-4">
                            <div>
                                <label for="tmax_min" class="block text-xs font-medium text-text-primary mb-1">T° Máx Mínima (°C)</label>
                                <input type="number" step="0.1" id="tmax_min" name="tmax_min" value="{{ filtros_aplicados.tmax_min }}"
                                       class="mt-1 block w-full rounded-lg border border-border-gray p-2 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                            </div>
                            <div>
                                <label for="precip_min" class="block text-xs font-medium text-text-primary mb-1">Lluvia Mínima (mm)</label>
                                <input type="number" step="0.1" id="precip_min" name="precip_min" value="{{ filtros_aplicados.precip_min }}"
                                       class="mt-1 block w-full rounded-lg border border-border-gray p-2 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                            </div>
                            <div>
                                <label for="viento_min" class="block text-xs font-medium text-text-primary mb-1">Viento Mínimo (km/h)</label>
                                <input type="number" step="0.1" id="viento_min" name="viento_min" value="{{ filtros_aplicados.viento_min }}"
                                       class="mt-1 block w-full rounded-lg border border-border-gray p-2 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="condiciones_filtro" class="block text-xs font-medium text-text-primary mb-1">Filtrar por Condición</label>
                                <select id="condiciones_filtro" name="condiciones_filtro"
                                        class="mt-1 block w-full rounded-lg border border-border-gray p-2.5 text-text-primary focus:border-primary-blue focus:ring-primary-blue shadow-sm text-sm">
                                    <option value="TODAS" {% if filtros_aplicados.condiciones_filtro == 'TODAS' %}selected{% endif %}>TODAS</option>
                                    <option value="Despejado" {% if filtros_aplicados.condiciones_filtro == 'Despejado' %}selected{% endif %}>Despejado</option>
                                    <option value="Mayormente Despejado a Parcialmente Nublado" {% if filtros_aplicados.condiciones_filtro == 'Mayormente Despejado a Parcialmente Nublado' %}selected{% endif %}>Mayormente Despejado/Nublado</option>
                                    <option value="Niebla / Escarcha" {% if filtros_aplicados.condiciones_filtro == 'Niebla / Escarcha' %}selected{% endif %}>Niebla / Escarcha</option>
                                    <option value="Llovizna" {% if filtros_aplicados.condiciones_filtro == 'Llovizna' %}selected{% endif %}>Llovizna</option>
                                    <option value="Lluvia Moderada" {% if filtros_aplicados.condiciones_filtro == 'Lluvia Moderada' %}selected{% endif %}>Lluvia Moderada</option>
                                    <option value="Aguaceros Fuertes" {% if filtros_aplicados.condiciones_filtro == 'Aguaceros Fuertes' %}selected{% endif %}>Aguaceros Fuertes</option>
                                    <option value="Tormenta" {% if filtros_aplicados.condiciones_filtro == 'Tormenta' %}selected{% endif %}>Tormenta</option>
                                    <option value="Condiciones Variadas" {% if filtros_aplicados.condiciones_filtro == 'Condiciones Variadas' %}selected{% endif %}>Condiciones Variadas</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                    class="inline-flex justify-center rounded-lg border border-transparent bg-primary-blue py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-offset-2 transition duration-150">
                                Consultar Historial
                            </button>
                        </div>
                    </form>
                </div>

                {% if error_message %}
                    <div class="bg-accent-red/10 border-l-4 border-accent-red p-4 rounded-lg">
                        <div class="flex">
                            <svg class="h-5 w-5 text-accent-red mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-11a1 1 0 112 0v4a1 1 0 11-2 0V7zm1 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                            <p class="text-sm text-accent-red font-medium">{{ error_message }}</p>
                        </div>
                    </div>
                {% elif datos_historial is not none %}
                    <!-- RESULTADOS Y EXPORTACIÓN -->
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-text-primary">
                                Resultados para {{ tienda_seleccionada }} ({{ filtros_aplicados.año_filtro }})
                            </h3>
                            <!-- Botones de Exportación -->
                            <div class="flex space-x-2">
                                <form id="export-form" method="POST" action="">
                                    <input type="hidden" name="datos_export_json" id="datos_export_json">
                                    <input type="hidden" name="datos_pdf_json" id="datos_pdf_json">
                                    <input type="hidden" name="tienda_nombre" value="{{ tienda_seleccionada }}">
                                    <input type="hidden" name="año_consulta" value="{{ filtros_aplicados.año_filtro }}">
                                    <button type="button" onclick="handleExport('csv')"
                                            class="inline-flex items-center rounded-lg border border-border-gray bg-white py-2 px-3 text-xs font-medium text-text-primary shadow-sm hover:bg-secondary-gray transition duration-150">
                                        Exportar CSV
                                    </button>
                                    <button type="button" onclick="handleExport('excel')"
                                            class="inline-flex items-center rounded-lg border border-border-gray bg-white py-2 px-3 text-xs font-medium text-text-primary shadow-sm hover:bg-secondary-gray transition duration-150">
                                        Exportar XLSX
                                    </button>
                                    <button type="button" onclick="handleExport('pdf')"
                                            class="inline-flex items-center rounded-lg border border-border-gray bg-white py-2 px-3 text-xs font-medium text-text-primary shadow-sm hover:bg-secondary-gray transition duration-150">
                                        Generar PDF
                                    </button>
                                </form>
                            </div>
                        </div>

                        {% if datos_historial | length > 0 %}
                            <div class="overflow-x-auto rounded-lg border border-border-gray shadow-sm">
                                <table class="min-w-full divide-y divide-border-gray">
                                    <thead class="bg-secondary-gray">
                                        <tr>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Fecha</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Día</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">T. Max (°C)</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">T. Min (°C)</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Lluvia (mm)</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Viento (km/h)</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Condiciones</th>
                                            <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary">Nubosidad (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-border-gray bg-white">
                                        {% for dia in datos_historial %}
                                            <tr>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm font-medium text-text-primary">{{ dia.fecha }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-primary">{{ dia.nombre_dia }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm font-medium text-text-primary">{{ dia.tmax | round(1) }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ dia.tmin | round(1) }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ dia.precipitacion_mm | round(1) }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ dia.viento_kmh | round(1) }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ dia.condiciones }}</td>
                                                <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ dia.nubosidad_perc }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <p class="mt-4 text-sm text-text-secondary">Mostrando {{ datos_historial | length }} días (de {{ datos_historial | length }} días en total, después de aplicar filtros).</p>
                        {% else %}
                            <div class="p-4 text-center text-text-secondary">No se encontraron datos para los filtros aplicados.</div>
                        {% endif %}
                    </div>
                {% endif %}

            {% elif seccion_activa == 'ranking' %}
                <!-- SECCIÓN: RANKING ANUAL -->
                <div class="bg-white shadow-lg rounded-xl p-6">
                    <h2 class="text-2xl font-semibold text-primary-blue mb-4">Ranking de Temperaturas Máximas Promedio ({{ ranking_data.fecha_inicio | default('N/A') }} a {{ ranking_data.fecha_fin | default('N/A') }})</h2>

                    {% if ranking_data.ranking | length > 0 %}
                        <div class="overflow-x-auto rounded-lg border border-border-gray shadow-sm">
                            <table class="min-w-full divide-y divide-border-gray">
                                <thead class="bg-secondary-gray">
                                    <tr>
                                        <th class="py-3 px-2 text-center text-xs font-semibold uppercase tracking-wider text-text-secondary w-1/12">#</th>
                                        <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary w-4/12">Tienda</th>
                                        <th class="py-3 px-2 text-left text-xs font-semibold uppercase tracking-wider text-text-secondary w-4/12">Tipo</th>
                                        <th class="py-3 px-2 text-right text-xs font-semibold uppercase tracking-wider text-text-secondary w-3/12">T° Máx Promedio (°C)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-border-gray bg-white">
                                    {% for item in ranking_data.ranking %}
                                        <tr class="{% if loop.index <= 3 %}bg-yellow-50/50{% endif %}">
                                            <td class="whitespace-nowrap py-3 px-2 text-center text-sm font-bold text-text-primary">{{ loop.index }}</td>
                                            <td class="whitespace-nowrap py-3 px-2 text-sm font-medium text-primary-blue">{{ item.tienda }}</td>
                                            <td class="whitespace-nowrap py-3 px-2 text-sm text-text-secondary">{{ item.tipo }}</td>
                                            <td class="whitespace-nowrap py-3 px-2 text-right text-sm font-semibold {% if item.tmax_promedio is not none and item.tmax_promedio >= 30 %}text-accent-red{% else %}text-highlight-green{% endif %}">
                                                {% if item.tmax_promedio is not none %}
                                                    {{ item.tmax_promedio | round(2) }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-text-secondary">No se pudo generar el ranking o no hay datos.</div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function handleExport(format) {
            const form = document.getElementById('export-form');
            const datosHistorial = {{ datos_historial | tojson | safe }}; // Datos ya filtrados por Flask

            if (!datosHistorial || datosHistorial.length === 0) {
                // Usar un modal o un mensaje dentro del DOM en lugar de alert()
                console.error('No hay datos filtrados para exportar.');
                // Aquí podrías mostrar un modal personalizado o un mensaje de error en la UI.
                return;
            }

            const datosJson = JSON.stringify(datosHistorial);
            document.getElementById('datos_export_json').value = datosJson;
            document.getElementById('datos_pdf_json').value = datosJson;

            if (format === 'csv') {
                form.action = "{{ url_for('exportar_datos', formato='csv') }}";
            } else if (format === 'excel') {
                form.action = "{{ url_for('exportar_datos', formato='excel') }}";
            } else if (format === 'pdf') {
                form.action = "{{ url_for('generar_pdf') }}";
            } else { return; }

            // Submit del formulario
            form.submit();
        }

        // Script para inyectar datos en formularios al cargar (Lógica sin cambios)
        document.addEventListener('DOMContentLoaded', () => {
            const datosHistorial = {{ datos_historial | tojson | safe }};
            if (datosHistorial && datosHistorial.length > 0) {
                const jsonStr = JSON.stringify(datosHistorial);
                // Si la página se carga con datos (ej. después de un POST) inyectamos el JSON para los botones de exportación
                const datosExportInput = document.getElementById('datos_export_json');
                const datosPdfInput = document.getElementById('datos_pdf_json');
                if (datosExportInput) datosExportInput.value = jsonStr;
                if (datosPdfInput) datosPdfInput.value = jsonStr;
            }
        });
    </script>
</body>
</html>
